<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVA Trade Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1100px;
            width: 100%;
        }
        .card {
            background-color: #2d3748;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            border: 1px solid #4a5568;
        }
        .btn {
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 9999px;
            transition: transform 0.1s, background-color 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .profit-text {
            color: #48bb78;
        }
        .loss-text {
            color: #f56565;
        }
        #loginBtn {
            background-color: #63b3ed;
        }
        #loginBtn:hover {
            background-color: #4c83a7;
        }
        #freeBtn {
            background-color: #4a5568;
        }
        #freeBtn:hover {
            background-color: #2d3748;
        }
        #addAccountBtn {
            background-color: #48bb78;
        }
        #addAccountBtn:hover {
            background-color: #38a169;
        }
        #renameBtn {
            background-color: #718096;
        }
        #renameBtn:hover {
            background-color: #5d687a;
        }
        #logoutBtn {
            background-color: #e53e3e;
        }
        #logoutBtn:hover {
            background-color: #c53030;
        }
        #restartBtn {
            background-color: #f56565;
        }
        #restartBtn:hover {
            background-color: #e53e3e;
        }
        #buyBtn {
            background-color: #48bb78;
        }
        #buyBtn:hover {
            background-color: #38a169;
        }
        #sellBtn {
            background-color: #f56565;
        }
        #sellBtn:hover {
            background-color: #e53e3e;
        }
        input, select {
            background-color: #4a5568;
            border: 1px solid #4a5568;
            color: #e2e8f0;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #63b3ed;
        }
        #transactionLog::-webkit-scrollbar {
            width: 8px;
        }
        #transactionLog::-webkit-scrollbar-track {
            background: #2d3748;
        }
        #transactionLog::-webkit-scrollbar-thumb {
            background: #718096;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
        .chart-controls button {
            padding: 8px 16px;
            font-weight: 600;
            border-radius: 9999px;
            background-color: #4a5568;
            color: #e2e8f0;
            transition: background-color 0.3s;
        }
        .chart-controls button.active {
            background-color: #63b3ed;
            color: white;
        }
        .small { font-size: 12px; }
    </style>
</head>
<body class="p-4">

    <!-- Halaman Login -->
    <div id="loginPage" class="card p-8 max-w-sm w-full space-y-6 text-center">
        <h1 class="text-3xl font-bold text-gray-100">Selamat Datang di AVA Trade</h1>
        <p class="text-gray-400">Silakan masuk dengan ID Anda atau mulai trading sekarang.</p>

        <div class="space-y-4">
            <input type="text" id="idInput" placeholder="Masukkan ID 5 Angka" class="w-full p-3 rounded-md focus:ring-2 focus:ring-blue-500 text-center">
            <p id="errorMsg" class="text-red-400 text-sm hidden">ID tidak valid. Silakan coba lagi.</p>
        </div>

        <div class="flex flex-col space-y-2">
            <button id="freeBtn" class="btn text-white">Mulai Trading</button>
            <button id="loginBtn" class="btn text-white">Login</button>
            <button id="addAccountBtn" class="btn text-white">Tambah Akun Baru</button>
        </div>
    </div>

    <!-- Halaman Simulator -->
    <div id="simulatorPage" class="container mx-auto p-6 space-y-6 hidden">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-gray-100">AVA Trade</h1>
            <div class="flex items-center justify-center space-x-2 mt-2">
                <p id="welcomeMessage" class="text-gray-400">Selamat datang!</p>
                <button id="renameBtn" class="btn text-white px-3 py-1 text-sm">Ubah Nama</button>
                <button id="logoutBtn" class="btn text-white px-3 py-1 text-sm hidden">Keluar</button>
                <button id="restartBtn" class="btn text-white px-3 py-1 text-sm hidden">Mulai Ulang</button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 flex flex-col space-y-4 lg:col-span-1">
                <h3 class="text-lg font-semibold text-gray-100">Panel Trading</h3>
                <div class="space-y-2">
                    <label for="stockSelect" class="block text-sm font-medium text-gray-300">Pilih Saham:</label>
                    <select id="stockSelect" class="w-full p-2 rounded-md focus:ring-2 focus:ring-blue-500">
                    </select>
                </div>
                
                <div class="space-y-2">
                    <p class="text-sm font-medium text-gray-300">Harga Saham Saat Ini:</p>
                    <span id="currentPrice" class="text-3xl font-bold text-gray-100">-</span>
                </div>

                <div class="space-y-2">
                    <label for="quantityInput" class="block text-sm font-medium text-gray-300">Jumlah Saham:</label>
                    <input type="number" id="quantityInput" value="1" min="1" class="w-full p-2 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-300">Atur Harga Otomatis (Opsional):</label>
                    <input type="number" id="stopLossInput" placeholder="Stop Loss (harga)" class="w-full p-2 rounded-md focus:ring-2 focus:ring-red-500">
                    <input type="number" id="takeProfitInput" placeholder="Take Profit (harga)" class="w-full p-2 rounded-md focus:ring-2 focus:ring-green-500">
                </div>

                <div class="flex flex-col space-y-2 sm:flex-row sm:space-x-2 sm:space-y-0">
                    <button id="buyBtn" class="btn text-white w-full sm:w-1/2">Beli</button>
                    <button id="sellBtn" class="btn text-white w-full sm:w-1/2">Jual</button>
                </div>
            </div>

            <div class="card p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-100">Grafik Harga</h3>
                    <div class="chart-controls space-x-2">
                        <button id="barChartBtn" class="active">Batang</button>
                        <button id="lineChartBtn">Garis</button>
                    </div>
                </div>
                <canvas id="stockChartCanvas"></canvas>
            </div>
            
            <div class="card p-6 lg:col-span-1">
                <h3 class="text-lg font-semibold text-gray-100">Portofolio Saya</h3>
                <p class="text-gray-300">Kas: <span id="cashBalance" class="font-semibold text-gray-100"></span></p>
                <div id="portfolioList" class="space-y-2">
                    <p class="text-gray-400">Portofolio kosong.</p>
                </div>
                <h4 class="text-sm font-semibold text-gray-100 mt-4">Pesanan Aktif</h4>
                <div id="activeOrdersList" class="space-y-2 text-sm">
                    <p class="text-gray-400">Tidak ada pesanan aktif.</p>
                </div>
            </div>
            
            <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg font-semibold text-gray-100 mb-4">Riwayat Transaksi</h3>
                <div id="transactionLog" class="space-y-2 text-sm max-h-96 overflow-y-auto">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fungsi untuk menghasilkan data historis yang disimulasikan
        function generateSimulatedHistory(startPrice) {
            return [{ x: 0, o: startPrice, h: startPrice, l: startPrice, c: startPrice }];
        }
        
        // Data saham terkemuka dengan data historis yang disimulasikan
        const stocks = {
            'BBRI': { name: 'Bank Rakyat Indonesia', history: generateSimulatedHistory(5200) },
            'BMRI': { name: 'Bank Mandiri', history: generateSimulatedHistory(6500) },
            'ADRO': { name: 'Adaro Energy', history: generateSimulatedHistory(2600) },
            'ICBP': { name: 'Indofood CBP', history: generateSimulatedHistory(11000) },
            'PGAS': { name: 'Perusahaan Gas Negara', history: generateSimulatedHistory(1450) },
            'TLKM': { name: 'Telekomunikasi Indonesia', history: generateSimulatedHistory(4200) },
            // GOTO modified: start price set inside requested range (20,000 - 10,000,000)
            'GOTO': { name: 'GoTo Gojek Tokopedia', history: generateSimulatedHistory(20000) },
            'ASII': { name: 'Astra International', history: generateSimulatedHistory(5300) },
            'BBCA': { name: 'Bank Central Asia', history: generateSimulatedHistory(9500) },
            'UNVR': { name: 'Unilever Indonesia', history: generateSimulatedHistory(3500) },
        };

        const initialUserData = {
            cash: 10000000,
            portfolio: {},
            transactions: [],
            activeOrders: []
        };
        const allowedUsernames = {
            '12345': 'Budi Santoso',
            '54321': 'Siti Aisyah',
            '67890': 'Andi Pratama',
            'akun_gratis': 'Akun Gratis'
        };

        let user = {};
        let stockChart;
        let currentChartType = 'bar';
        const MA_PERIOD = 5;
        let updateInterval;

        const loginPage = document.getElementById('loginPage');
        const simulatorPage = document.getElementById('simulatorPage');
        const idInput = document.getElementById('idInput');
        const loginBtn = document.getElementById('loginBtn');
        const freeBtn = document.getElementById('freeBtn');
        const addAccountBtn = document.getElementById('addAccountBtn');
        const renameBtn = document.getElementById('renameBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const restartBtn = document.getElementById('restartBtn');
        const errorMsg = document.getElementById('errorMsg');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const stockSelect = document.getElementById('stockSelect');
        const currentPriceSpan = document.getElementById('currentPrice');
        const quantityInput = document.getElementById('quantityInput');
        const stopLossInput = document.getElementById('stopLossInput');
        const takeProfitInput = document.getElementById('takeProfitInput');
        const buyBtn = document.getElementById('buyBtn');
        const sellBtn = document.getElementById('sellBtn');
        const cashBalanceSpan = document.getElementById('cashBalance');
        const portfolioList = document.getElementById('portfolioList');
        const activeOrdersList = document.getElementById('activeOrdersList');
        const transactionLog = document.getElementById('transactionLog');
        const chartCanvas = document.getElementById('stockChartCanvas').getContext('2d');
        const barChartBtn = document.getElementById('barChartBtn');
        const lineChartBtn = document.getElementById('lineChartBtn');
        
        // Fungsi pembantu untuk menghitung Moving Average (MA)
        function calculateMA(data, period) {
            let ma = [];
            let closePrices = data.map(d => d.c);
            for (let i = 0; i < closePrices.length; i++) {
                if (i < period - 1) {
                    ma.push(null);
                } else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += closePrices[i - j];
                    }
                    ma.push(sum / period);
                }
            }
            return ma;
        }

        // Memuat akun dinamis dari localStorage
        function loadDynamicAccounts() {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('user_')) {
                    const userId = key.substring(5);
                    const userData = JSON.parse(localStorage.getItem(key));
                    if (userData && userData.username) {
                        allowedUsernames[userId] = userData.username;
                    }
                }
            }
        }

        function saveStateToLocalStorage() {
            if (user && user.userId !== 'akun_gratis') {
                localStorage.setItem(`user_${user.userId}`, JSON.stringify(user));
            }
        }

        function loadUser(userId) {
            const storedData = localStorage.getItem(`user_${userId}`);
            if (storedData) {
                user = JSON.parse(storedData);
            } else {
                user = { ...initialUserData };
            }
            user.userId = userId;
            user.username = allowedUsernames[userId];
            if (!user.username) {
                user.username = 'Pemain';
            }
        }

        function handleLogin(isFreeAccount = false) {
            const freeAccountId = 'akun_gratis';
            const enteredId = idInput.value;

            if (isFreeAccount) {
                loadUser(freeAccountId);
                localStorage.setItem('currentUserId', freeAccountId);
                showSimulator();
            } else {
                if (Object.keys(allowedUsernames).includes(enteredId)) {
                    loadUser(enteredId);
                    localStorage.setItem('currentUserId', enteredId);
                    showSimulator();
                } else {
                    errorMsg.classList.remove('hidden');
                }
            }
        }

        function handleLogout() {
            Swal.fire({
                title: 'Konfirmasi',
                text: 'Apakah Anda yakin ingin keluar? Data Anda akan disimpan.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('currentUserId');
                    user = {};
                    simulatorPage.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                    idInput.value = '';
                    errorMsg.classList.add('hidden');
                    clearInterval(updateInterval);
                }
            });
        }

        function handleRestart() {
            Swal.fire({
                title: 'Konfirmasi',
                text: 'Apakah Anda yakin ingin memulai ulang? Semua data Anda akan direset.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Mulai Ulang!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem(`user_${user.userId}`);
                    localStorage.removeItem('currentUserId');
                    user = {};
                    simulatorPage.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                    idInput.value = '';
                    errorMsg.classList.add('hidden');
                    clearInterval(updateInterval);
                    Swal.fire({
                        title: 'Berhasil!',
                        text: 'Permainan telah direset.',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        function showSimulator() {
            loginPage.classList.add('hidden');
            simulatorPage.classList.remove('hidden');
            welcomeMessage.textContent = `Selamat datang, ${user.username}!`;
            
            // Tampilkan tombol yang sesuai berdasarkan jenis akun
            if (user.userId === 'akun_gratis') {
                logoutBtn.classList.add('hidden');
                restartBtn.classList.remove('hidden');
            } else {
                logoutBtn.classList.remove('hidden');
                restartBtn.classList.add('hidden');
            }
            
            initSimulator();
        }

        function initSimulator() {
            populateStockSelect();
            updateUI();
            updateChart();
            stockSelect.addEventListener('change', () => {
                updateUI();
                updateChart();
            });
            buyBtn.addEventListener('click', handleBuy);
            sellBtn.addEventListener('click', () => handleSell());
            renameBtn.addEventListener('click', handleRenameAccount);
            logoutBtn.addEventListener('click', handleLogout);
            restartBtn.addEventListener('click', handleRestart);
            barChartBtn.addEventListener('click', () => {
                currentChartType = 'bar';
                updateChart();
                updateChartButtons();
            });
            lineChartBtn.addEventListener('click', () => {
                currentChartType = 'line';
                updateChart();
                updateChartButtons();
            });
            
            // Interval untuk memperbarui data dan grafik secara berkala
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(() => {
                updateRandomStock();
                checkActiveOrders();
            }, 3000);

            // show first time popup only once per device (if logged)
            showFirstTimePopup();
        }

        function updateChartButtons() {
            barChartBtn.classList.remove('active');
            lineChartBtn.classList.remove('active');
            if (currentChartType === 'bar') {
                barChartBtn.classList.add('active');
            } else {
                lineChartBtn.classList.add('active');
            }
        }

        function populateStockSelect() {
            stockSelect.innerHTML = '';
            for (const symbol in stocks) {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = `${symbol} - ${stocks[symbol].name}`;
                stockSelect.appendChild(option);
            }
        }

        function updateUI() {
            // Guard clause untuk mencegah error
            if (!user || typeof user.cash === 'undefined') {
                return;
            }
            
            const selectedSymbol = stockSelect.value;
            
            if (!selectedSymbol || !stocks[selectedSymbol] || stocks[selectedSymbol].history.length === 0) {
                currentPriceSpan.textContent = `N/A`;
            } else {
                const currentPrice = stocks[selectedSymbol].history[stocks[selectedSymbol].history.length - 1].c;
                currentPriceSpan.textContent = `Rp ${currentPrice.toLocaleString('id-ID')}`;
            }
            
            cashBalanceSpan.textContent = `Rp ${user.cash.toLocaleString('id-ID')}`;
            
            renderPortfolio();
            renderActiveOrders();
            renderTransactionLog();
        }

        function renderPortfolio() {
            portfolioList.innerHTML = '';
            let hasStocks = false;
            for (const symbol in user.portfolio) {
                const stockData = user.portfolio[symbol];
                if (stockData.quantity > 0) {
                    const currentPrice = stocks[symbol].history[stocks[symbol].history.length - 1].c;
                    const totalValue = stockData.quantity * currentPrice;
                    const profitLoss = totalValue - (stockData.quantity * stockData.avgPrice);
                    const profitLossPercent = (profitLoss / (stockData.quantity * stockData.avgPrice)) * 100;
                    
                    const pLClass = profitLoss >= 0 ? 'profit-text' : 'loss-text';
                    const pLText = `${profitLoss >= 0 ? '+' : ''}Rp ${profitLoss.toLocaleString('id-ID')} (${profitLossPercent.toFixed(2)}%)`;

                    const stockItem = document.createElement('div');
                    stockItem.classList.add('flex', 'flex-col', 'border-b', 'border-gray-600', 'py-2');
                    stockItem.innerHTML = `
                        <p class="text-sm font-semibold text-gray-200">${symbol} <span class="text-gray-400 font-normal">(${stockData.quantity} saham)</span></p>
                        <p class="text-xs text-gray-400">Nilai: Rp ${totalValue.toLocaleString('id-ID')}</p>
                        <p class="text-xs ${pLClass}">Untung/Rugi: ${pLText}</p>
                    `;
                    portfolioList.appendChild(stockItem);
                    hasStocks = true;
                }
            }
            if (!hasStocks) {
                portfolioList.innerHTML = '<p class="text-gray-400">Portofolio kosong.</p>';
            }
        }
        
        function renderActiveOrders() {
            activeOrdersList.innerHTML = '';
            if (user.activeOrders.length === 0) {
                activeOrdersList.innerHTML = '<p class="text-gray-400">Tidak ada pesanan aktif.</p>';
                return;
            }
            user.activeOrders.forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.classList.add('border-b', 'border-gray-600', 'py-2');
                orderItem.innerHTML = `
                    <p class="font-semibold text-gray-200">${order.symbol} (${order.quantity} saham)</p>
                    ${order.stopLoss ? `<p class="text-xs text-red-400">Stop Loss: Rp ${order.stopLoss.toLocaleString('id-ID')}</p>` : ''}
                    ${order.takeProfit ? `<p class="text-xs text-green-400">Take Profit: Rp ${order.takeProfit.toLocaleString('id-ID')}</p>` : ''}
                `;
                activeOrdersList.appendChild(orderItem);
            });
        }
        
        function renderTransactionLog() {
            transactionLog.innerHTML = '';
            if (user.transactions.length === 0) {
                transactionLog.innerHTML = '<p class="text-gray-400">Belum ada transaksi.</p>';
                return;
            }
            user.transactions.slice().reverse().forEach(tx => {
                const txItem = document.createElement('div');
                const txClass = tx.type.includes('Jual') ? 'loss-text' : 'profit-text';
                txItem.classList.add('border-b', 'border-gray-600', 'py-2');
                txItem.innerHTML = `
                    <p><span class="font-bold ${txClass}">${tx.type}</span> ${tx.quantity} saham ${tx.symbol} @ Rp ${tx.price.toLocaleString('id-ID')}</p>
                    <p class="text-xs text-gray-500">${new Date(tx.timestamp).toLocaleTimeString()}</p>
                `;
                transactionLog.appendChild(txItem);
            });
        }

        function updateChart() {
            const selectedSymbol = stockSelect.value;
            const stockHistory = stocks[selectedSymbol].history;
            
            if (stockChart) {
                stockChart.destroy();
            }

            const maData = calculateMA(stockHistory, MA_PERIOD);
            const datasets = [{
                label: `MA (${MA_PERIOD} Periode)`,
                data: maData,
                type: 'line',
                borderColor: '#fcd34d',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                tension: 0.1,
                fill: false,
                backgroundColor: '#fcd34d'
            }];
            const labels = stockHistory.map(d => `Poin ${d.x}`);

            if (currentChartType === 'bar') {
                const barData = stockHistory.map(d => d.c);
                const barColors = barData.map((price, index) => {
                    if (index === 0) return '#48bb78';
                    const prevPrice = stockHistory[index - 1].c;
                    return price >= prevPrice ? '#48bb78' : '#f56565';
                });

                datasets.unshift({
                    label: `Harga Saham ${selectedSymbol}`,
                    data: barData,
                    backgroundColor: barColors,
                    borderColor: barColors,
                    borderWidth: 1,
                    barPercentage: 0.8,
                    categoryPercentage: 0.9,
                    type: 'bar',
                });
            } else if (currentChartType === 'line') {
                const lineData = stockHistory.map(d => d.c);
                datasets.unshift({
                    label: `Harga Saham ${selectedSymbol}`,
                    data: lineData,
                    borderColor: '#63b3ed',
                    borderWidth: 2,
                    pointRadius: 3, // Diubah untuk menampilkan titik
                    tension: 0.1,
                    fill: false,
                    backgroundColor: '#63b3ed',
                    type: 'line',
                });
            }

            const chartConfig = {
                type: 'bar', // Set to a default type, the datasets will define the actual chart type
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: '#e2e8f0',
                                callback: function(value) {
                                    // Prevent too long numbers in chart ticks
                                    if (Math.abs(value) >= 1000000) {
                                        return `Rp ${ (value/1000000).toFixed(1) }M`;
                                    }
                                    return `Rp ${value.toLocaleString('id-ID')}`;
                                }
                            },
                            grid: {
                                color: '#4a5568'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e2e8f0',
                            },
                            grid: {
                                color: '#4a5568'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e2e8f0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed.y;
                                    return `Rp ${val.toLocaleString('id-ID')}`;
                                }
                            }
                        }
                    }
                }
            };

            stockChart = new Chart(chartCanvas, chartConfig);
        }

        // Clamp helper
        function clamp(val, min, max) {
            return Math.max(min, Math.min(max, val));
        }

        function updateRandomStock() {
            // Perbarui harga semua saham
            for (const symbol in stocks) {
                const history = stocks[symbol].history;
                const lastPrice = history[history.length - 1].c;
                const lastCheckpoint = history[history.length - 1].x;
                
                // Perbedaan volatility untuk saham murah vs mahal
                // untuk saham tinggi seperti GOTO, kita gunakan volatilitas relatif kecil
                let relativeVolatility = 0.005; // default 0.5%
                if (lastPrice > 100000) relativeVolatility = 0.002; // kurang volatile di harga besar
                if (lastPrice < 500) relativeVolatility = 0.01; // lebih volatile di harga kecil

                // Menambahkan bias positif kecil (simulasi pertumbuhan)
                const positiveBias = lastPrice * 0.00005;
                const randomFluctuation = (Math.random() - 0.5) * lastPrice * relativeVolatility;
                const change = positiveBias + randomFluctuation;

                const newOpen = lastPrice;
                let newClose = Math.round(lastPrice + change);

                // Khusus GOTO: pastikan tetap berada di range 20.000 - 10.000.000
                if (symbol === 'GOTO') {
                    newClose = clamp(newClose, 20000, 10000000);
                } else {
                    // Hindari harga <= 0 untuk saham lain
                    newClose = newClose > 0 ? newClose : 1;
                }

                // Hitung high/low wajar di sekitar open/close, lalu clamp untuk GOTO
                const highCandidate = Math.max(newOpen, newClose) + Math.round(Math.random() * lastPrice * 0.01);
                const lowCandidate = Math.min(newOpen, newClose) - Math.round(Math.random() * lastPrice * 0.01);

                let newHigh = Math.max(newOpen, newClose, highCandidate);
                let newLow = Math.min(newOpen, newClose, lowCandidate);

                if (symbol === 'GOTO') {
                    newHigh = clamp(newHigh, 20000, 10000000);
                    newLow = clamp(newLow, 20000, 10000000);
                } else {
                    newHigh = newHigh > 0 ? newHigh : 1;
                    newLow = newLow > 0 ? newLow : 1;
                }

                history.push({ x: lastCheckpoint + 1, o: newOpen, h: newHigh, l: newLow, c: newClose });
                
                // keep history length reasonable
                if (history.length > 500) history.shift();
            }
            
            // Perbarui data grafik hanya untuk saham yang sedang dipilih
            updateChart();
            
            updateUI();
        }

        function checkActiveOrders() {
            const ordersToExecute = [];
            user.activeOrders.forEach(order => {
                const currentPrice = stocks[order.symbol].history.slice(-1)[0].c;
                const reason = order.stopLoss && currentPrice <= order.stopLoss ? 'Stop Loss' : (order.takeProfit && currentPrice >= order.takeProfit ? 'Take Profit' : null);
                
                if (reason) {
                    ordersToExecute.push({ ...order, reason: reason });
                }
            });
            
            ordersToExecute.forEach(order => {
                handleSell(order.symbol, order.quantity, order.reason);
                user.activeOrders = user.activeOrders.filter(o => o.symbol !== order.symbol);
            });
            
            updateUI();
            saveStateToLocalStorage();
        }

        function handleBuy() {
            const selectedSymbol = stockSelect.value;
            const quantity = parseInt(quantityInput.value, 10);
            const stopLossPrice = parseFloat(stopLossInput.value) || null;
            const takeProfitPrice = parseFloat(takeProfitInput.value) || null;
            const currentPrice = stocks[selectedSymbol].history[stocks[selectedSymbol].history.length - 1].c;
            const cost = quantity * currentPrice;

            if (isNaN(quantity) || quantity <= 0) {
                Swal.fire({ icon: 'error', title: 'Gagal!', text: 'Jumlah saham tidak valid.' });
                return;
            }

            if (user.cash >= cost) {
                user.cash -= cost;
                
                if (!user.portfolio[selectedSymbol]) {
                    user.portfolio[selectedSymbol] = { quantity: 0, avgPrice: 0 };
                }
                const existingQty = user.portfolio[selectedSymbol].quantity;
                const existingTotal = existingQty * user.portfolio[selectedSymbol].avgPrice;
                const newTotal = existingTotal + cost;
                const newQty = existingQty + quantity;

                user.portfolio[selectedSymbol].quantity = newQty;
                user.portfolio[selectedSymbol].avgPrice = newTotal / newQty;

                user.transactions.push({
                    type: 'Beli',
                    symbol: selectedSymbol,
                    quantity: quantity,
                    price: currentPrice,
                    timestamp: new Date().getTime()
                });
                
                if (stopLossPrice || takeProfitPrice) {
                    user.activeOrders.push({
                        symbol: selectedSymbol,
                        quantity: quantity,
                        stopLoss: stopLossPrice,
                        takeProfit: takeProfitPrice
                    });
                }
                
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: `Anda berhasil membeli ${quantity} saham ${selectedSymbol}.`
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal!',
                    text: 'Saldo kas tidak mencukupi.'
                });
            }
            stopLossInput.value = '';
            takeProfitInput.value = '';
            updateUI();
            saveStateToLocalStorage();
        }

        // Fungsi untuk menangani penjualan saham
        function handleSell(symbol = null, quantity = null, reason = null) {
            const selectedSymbol = symbol || stockSelect.value;
            const sellQuantity = quantity || parseInt(quantityInput.value, 10);
            const currentPrice = stocks[selectedSymbol].history[stocks[selectedSymbol].history.length - 1].c;
            
            if (isNaN(sellQuantity) || sellQuantity <= 0) {
                if (!reason) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal!',
                        text: `Jumlah saham tidak valid.`
                    });
                }
                return;
            }

            const portfolioStock = user.portfolio[selectedSymbol];

            if (portfolioStock && portfolioStock.quantity >= sellQuantity) {
                const revenue = sellQuantity * currentPrice;
                const profitLoss = (currentPrice - portfolioStock.avgPrice) * sellQuantity;
                
                user.cash += revenue;
                portfolioStock.quantity -= sellQuantity;
                
                user.transactions.push({
                    type: reason ? `Jual (${reason})` : 'Jual',
                    symbol: selectedSymbol,
                    quantity: sellQuantity,
                    price: currentPrice,
                    timestamp: new Date().getTime(),
                    profitLoss: profitLoss
                });
                
                if (!reason) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        html: `Anda berhasil menjual ${sellQuantity} saham ${selectedSymbol}.<br>Untung/Rugi: <span class="${profitLoss >= 0 ? 'profit-text' : 'loss-text'}">Rp ${profitLoss.toLocaleString('id-ID')}</span>`
                    });
                }
            } else {
                if (!reason) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal!',
                        text: `Anda tidak memiliki cukup saham ${selectedSymbol} untuk dijual.`
                    });
                }
            }
            if (!reason) {
                quantityInput.value = '1';
            }
            updateUI();
            saveStateToLocalStorage();
        }

        // --- Fungsi untuk Manajemen Akun Pengguna ---

        function handleAddAccount() {
            Swal.fire({
                title: 'Tambah Akun Baru',
                html: `
                    <input id="swal-id" class="swal2-input" placeholder="ID 5 Angka (contoh: 12345)">
                    <input id="swal-name" class="swal2-input" placeholder="Nama Anda">
                `,
                confirmButtonText: 'Buat Akun',
                focusConfirm: false,
                preConfirm: () => {
                    const id = Swal.getPopup().querySelector('#swal-id').value;
                    const name = Swal.getPopup().querySelector('#swal-name').value;
                    if (!id || !name || id.length !== 5) {
                        Swal.showValidationMessage(`Harap masukkan ID 5 angka dan nama.`);
                        return false;
                    }
                    if (Object.keys(allowedUsernames).includes(id)) {
                        Swal.showValidationMessage(`ID ${id} sudah digunakan.`);
                        return false;
                    }
                    return { id: id, name: name };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newId = result.value.id;
                    const newName = result.value.name;
                    allowedUsernames[newId] = newName;
                    const newUserData = { ...initialUserData, username: newName };
                    localStorage.setItem(`user_${newId}`, JSON.stringify(newUserData));
                    Swal.fire({
                        icon: 'success',
                        title: 'Akun Berhasil Dibuat!',
                        text: `Akun dengan ID ${newId} dan nama ${newName} telah berhasil dibuat.`,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        idInput.value = newId;
                        handleLogin();
                    });
                }
            });
        }

        function handleRenameAccount() {
            Swal.fire({
                title: 'Ubah Nama Akun',
                input: 'text',
                inputValue: user.username,
                inputPlaceholder: 'Nama Baru Anda',
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                cancelButtonText: 'Batal',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Nama tidak boleh kosong!';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    user.username = result.value;
                    allowedUsernames[user.userId] = user.username;
                    saveStateToLocalStorage();
                    welcomeMessage.textContent = `Selamat datang, ${user.username}!`;
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: 'Nama akun Anda telah diperbarui.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        // FIRST TIME POPUP (muncul sekali)
        function showFirstTimePopup() {
            const hasSeenPopup = localStorage.getItem('ava_first_popup_shown');

            if (!hasSeenPopup) {
                Swal.fire({
                    title: 'Selamat Datang di AVA Trade!',
                    html: `
                        <div style="text-align:left; line-height:1.6; font-size:15px;">
                            <b style="color:#63b3ed">Peringatan Cepat:</b><br>
                            â€¢ Ini hanya simulator, bukan trading asli<br>
                            â€¢ Harga bergerak otomatis sebagai simulasi<br>
                            â€¢ Gunakan <b>Stop Loss</b> untuk batas rugi<br>
                            â€¢ Gunakan <b>Take Profit</b> untuk target cuan<br>
                            â€¢ Belajar dulu, jangan FOMO ðŸ˜Ž<br><br>
                            <i style="color:#a0aec0">Semoga simulasi ini bikin lo makin jago trading âœ¨</i>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: 'Gaskeun ðŸ˜Ž',
                    confirmButtonColor: '#3b82f6',
                    background: '#1e293b',
                    color: '#e2e8f0',
                    width: '420px',
                    backdrop: `rgba(0,0,0,0.7)`
                });

                localStorage.setItem('ava_first_popup_shown', 'true');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDynamicAccounts();
            loginBtn.addEventListener('click', () => handleLogin());
            freeBtn.addEventListener('click', () => handleLogin(true));
            addAccountBtn.addEventListener('click', handleAddAccount);
            idInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            const currentUserId = localStorage.getItem('currentUserId');
            if (currentUserId) {
                loadUser(currentUserId);
                showSimulator();
            }
        });
    </script>
</body>
</html>
